// Enhanced Portfolio JavaScript with Modern Interactions

/* ==================== Scroll Header Enhancement ==================== */
const header = document.getElementById('header');
const menuIcon = document.getElementById('menu-icon');
const navbar = document.getElementById('navbar');

window.addEventListener('scroll', () => {
if (window.scrollY > 100) {
header.classList.add('scrolled');
} else {
header.classList.remove('scrolled');
}
});

/* ==================== Menu Toggle ==================== */
menuIcon.addEventListener('click', () => {
navbar.classList.toggle('active');
menuIcon.classList.toggle('bx-x');
});

// Close menu when clicking a menu item
document.querySelectorAll('.navbar a').forEach(link => {
link.addEventListener('click', () => {
navbar.classList.remove('active');
menuIcon.classList.remove('bx-x');
});
});

// Close menu when clicking outside
document.addEventListener('click', (e) => {
if (!navbar.contains(e.target) && !menuIcon.contains(e.target)) {
navbar.classList.remove('active');
menuIcon.classList.remove('bx-x');
}
});

/* ==================== Active Menu Highlighting ==================== */
const sections = document.querySelectorAll('section');
const navLinks = document.querySelectorAll('header nav a');

window.addEventListener('scroll', () => {
let current = '';
sections.forEach(section => {
const sectionTop = section.offsetTop;
const sectionHeight = section.clientHeight;
if (window.scrollY >= sectionTop - 150) {
current = section.getAttribute('id');
}
});

navLinks.forEach(link => {
link.classList.remove('active');
if (link.getAttribute('href').includes(current)) {
link.classList.add('active');
}
});
});

/* ==================== Smooth Scroll ==================== */
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
anchor.addEventListener('click', function (e) {
e.preventDefault();
const target = document.querySelector(this.getAttribute('href'));
if (target) {
const offsetTop = target.offsetTop - 80;
window.scrollTo({
top: offsetTop,
behavior: 'smooth'
});
}
});
});

/* ==================== Typed.js Animation ==================== */
const typed = new Typed('.text-animation span', {
strings: [
'Frontend Developer',
'Backend Developer',
'MERN Stack Developer',
'Software Developer'
],
typeSpeed: 80,
backSpeed: 60,
backDelay: 1500,
loop: true,
showCursor: true,
cursorChar: '|'
});

/* ==================== âœ… SKILLS PROGRESS ANIMATION (FIXED) ==================== */
// Animate skill circles on scroll
function animateSkills() {
const skillCircles = document.querySelectorAll('.skill-circle');

const observer = new IntersectionObserver((entries) => {
entries.forEach(entry => {
if (entry.isIntersecting) {
const circle = entry.target;
const progressCircle = circle.querySelector('.progress-circle');
const percentageValue = circle.querySelector('.percentage-value');
const targetPercent = parseInt(circle.getAttribute('data-percent'));

// Calculate stroke-dashoffset
const circumference = 2 * Math.PI * 60; // r=60
const offset = circumference - (targetPercent / 100) * circumference;

// Set initial stroke-dash properties
progressCircle.style.strokeDasharray = circumference;
progressCircle.style.strokeDashoffset = circumference;

// Animate the circle
setTimeout(() => {
progressCircle.style.transition = 'stroke-dashoffset 2s ease';
progressCircle.style.strokeDashoffset = offset;
}, 100);

// Animate the percentage counter
let currentPercent = 0;
const duration = 2000; // 2 seconds
const increment = targetPercent / (duration / 16); // ~60 fps

const counter = setInterval(() => {
currentPercent += increment;
if (currentPercent >= targetPercent) {
currentPercent = targetPercent;
clearInterval(counter);
}
percentageValue.textContent = Math.floor(currentPercent);
}, 16);

// Unobserve after animation starts
observer.unobserve(circle);
}
});
}, {
threshold: 0.5
});

skillCircles.forEach(circle => observer.observe(circle));
}

// Initialize skills animation on DOM load
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', animateSkills);
} else {
animateSkills();
}

/* ==================== âœ… CUSTOM CURSOR (FIXED) ==================== */
// Check if device supports custom cursor (not touch)
const isTouchDevice = window.matchMedia('(pointer: coarse)').matches;

if (!isTouchDevice) {
// Create cursor elements
const cursor = document.createElement('div');
const cursorDot = document.createElement('div');

cursor.className = 'custom-cursor';
cursorDot.className = 'custom-cursor-dot';

document.body.appendChild(cursor);
document.body.appendChild(cursorDot);

// Cursor position
let mouseX = 0;
let mouseY = 0;
let cursorX = 0;
let cursorY = 0;
let dotX = 0;
let dotY = 0;

// Track mouse movement
document.addEventListener('mousemove', (e) => {
mouseX = e.clientX;
mouseY = e.clientY;
});

// Smooth cursor animation
function animateCursor() {
// Smooth follow with easing
cursorX += (mouseX - cursorX) * 0.1;
cursorY += (mouseY - cursorY) * 0.1;
dotX += (mouseX - dotX) * 0.3;
dotY += (mouseY - dotY) * 0.3;

cursor.style.left = `${cursorX}px`;
cursor.style.top = `${cursorY}px`;
cursorDot.style.left = `${dotX}px`;
cursorDot.style.top = `${dotY}px`;

requestAnimationFrame(animateCursor);
}

animateCursor();

// Cursor interactions
const interactiveElements = document.querySelectorAll('a, button, input, textarea, .portfolio-box, .tech-item,
.skill-item, .project-box');

interactiveElements.forEach(el => {
el.addEventListener('mouseenter', () => {
cursor.classList.add('cursor-hover');
cursorDot.classList.add('cursor-hover');
});

el.addEventListener('mouseleave', () => {
cursor.classList.remove('cursor-hover');
cursorDot.classList.remove('cursor-hover');
});
});

// Hide custom cursor when mouse leaves window
document.addEventListener('mouseleave', () => {
cursor.style.opacity = '0';
cursorDot.style.opacity = '0';
});

document.addEventListener('mouseenter', () => {
cursor.style.opacity = '1';
cursorDot.style.opacity = '1';
});
}

/* ==================== Form Validation & Submission ==================== */
const form = document.querySelector('form');

// Input elements
const fullNameInput = document.getElementById('fullName');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const subjectInput = document.getElementById('subject');
const messageInput = document.getElementById('message');

// Validation functions
function validateName() {
const name = fullNameInput.value.trim();
return name.length >= 2 && /^[a-zA-Z\s-]+$/.test(name);
}

function validateEmail() {
const email = emailInput.value.trim();
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
return emailRegex.test(email);
}

function validatePhone() {
const phone = phoneInput.value.trim();
const phoneRegex = /^[0-9]{10}$/;
return phoneRegex.test(phone);
}

function validateSubject() {
return subjectInput.value.trim().length >= 3;
}

function validateMessage() {
return messageInput.value.trim().length >= 10;
}

// Real-time validation feedback
function addValidationFeedback(input, isValid) {
if (isValid) {
input.style.borderColor = 'rgba(34, 197, 94, 0.5)';
} else if (input.value.length > 0) {
input.style.borderColor = 'rgba(239, 68, 68, 0.5)';
} else {
input.style.borderColor = 'rgba(255, 255, 255, 0.1)';
}
}

fullNameInput.addEventListener('blur', () => {
addValidationFeedback(fullNameInput, validateName());
});

emailInput.addEventListener('blur', () => {
addValidationFeedback(emailInput, validateEmail());
});

phoneInput.addEventListener('blur', () => {
addValidationFeedback(phoneInput, validatePhone());
});

subjectInput.addEventListener('blur', () => {
addValidationFeedback(subjectInput, validateSubject());
});

messageInput.addEventListener('blur', () => {
addValidationFeedback(messageInput, validateMessage());
});

// Toast notification function
function showToast(message, type = 'success') {
const backgroundColor = type === 'success'
? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';

Toastify({
text: message,
duration: 3000,
close: true,
gravity: 'top',
position: 'center',
stopOnFocus: true,
style: {
background: backgroundColor,
fontSize: '1.6rem',
borderRadius: '1rem',
padding: '1.5rem 2.5rem',
boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
}
}).showToast();
}

// Email sending function
function sendEmail() {
const fullName = fullNameInput.value.trim();
const email = emailInput.value.trim();
const phone = phoneInput.value.trim();
const subject = subjectInput.value.trim();
const message = messageInput.value.trim();

const emailBody = `
<div style="font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5;">
  <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; margin: 0 auto;">
    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
      New Contact Form Submission
    </h2>
    <p style="margin: 20px 0;"><strong>Full Name:</strong> ${fullName}</p>
    <p style="margin: 20px 0;"><strong>Email:</strong> ${email}</p>
    <p style="margin: 20px 0;"><strong>Phone:</strong> ${phone}</p>
    <p style="margin: 20px 0;"><strong>Subject:</strong> ${subject}</p>
    <p style="margin: 20px 0;"><strong>Message:</strong></p>
    <p style="background: #f9f9f9; padding: 15px; border-left: 4px solid #667eea; margin: 10px 0;">
      ${message}
    </p>
  </div>
</div>
`;

Email.send({
SecureToken: "40b0323c-46a8-4596-a89b-ac42652648b8",
To: "kumawatking6848@gmail.com",
From: "kumawatking6848@gmail.com",
Subject: `Portfolio Contact: ${subject}`,
Body: emailBody
}).then(response => {
if (response === 'OK') {
showToast('âœ¨ Message sent successfully! I\'ll get back to you soon.', 'success');

// Reset form with animation
setTimeout(() => {
form.reset();
// Reset border colors
[fullNameInput, emailInput, phoneInput, subjectInput, messageInput].forEach(input => {
input.style.borderColor = 'rgba(255, 255, 255, 0.1)';
});
}, 1000);
} else {
showToast('âš ï¸ Failed to send message. Please try again.', 'error');
}
}).catch(error => {
console.error('Email error:', error);
showToast('âš ï¸ An error occurred. Please try again later.', 'error');
});
}

// Form submission handler
form.addEventListener('submit', (e) => {
e.preventDefault();

// Validate all fields
if (!validateName()) {
showToast('âš ï¸ Please enter a valid full name (letters only)', 'error');
fullNameInput.focus();
return;
}

if (!validateEmail()) {
showToast('âš ï¸ Please enter a valid email address', 'error');
emailInput.focus();
return;
}

if (!validatePhone()) {
showToast('âš ï¸ Please enter a valid 10-digit phone number', 'error');
phoneInput.focus();
return;
}

if (!validateSubject()) {
showToast('âš ï¸ Please enter a subject (minimum 3 characters)', 'error');
subjectInput.focus();
return;
}

if (!validateMessage()) {
showToast('âš ï¸ Please enter a message (minimum 10 characters)', 'error');
messageInput.focus();
return;
}

// All validations passed, send email
sendEmail();
});

/* ==================== Loading Animation ==================== */
// âœ… FIXED: Added percentage counter and maximum timeout failsafe
const loader = document.getElementById('loader');
const loaderCount = document.getElementById('loader-count');

// Animate percentage counter from 0 to 100
let currentPercent = 0;
const percentInterval = setInterval(() => {
if (currentPercent < 100) { currentPercent +=Math.random() * 15; // Random increment for realistic feel if
  (currentPercent> 100) currentPercent = 100;
  if (loaderCount) {
  loaderCount.textContent = Math.floor(currentPercent);
  }
  } else {
  clearInterval(percentInterval);
  }
  }, 100);

  // Function to hide loader
  function hideLoader() {
  if (loader && !loader.classList.contains('fade-out')) {
  // Ensure counter reaches 100%
  if (loaderCount) loaderCount.textContent = '100';

  setTimeout(() => {
  loader.classList.add('fade-out');
  setTimeout(() => {
  loader.style.display = 'none';
  loader.remove();
  document.body.style.overflow = 'auto';
  clearInterval(percentInterval); // Clean up interval
  }, 500);
  }, 300);
  }
  }

  // Hide loader on window load
  window.addEventListener('load', () => {
  hideLoader();

  // Fade in body content
  document.body.style.opacity = '0';
  setTimeout(() => {
  document.body.style.transition = 'opacity 0.5s ease';
  document.body.style.opacity = '1';
  }, 100);
  });

  // âœ… CRITICAL FIX: Maximum timeout failsafe (5 seconds)
  // This ensures the loader ALWAYS disappears, even if 'load' event doesn't fire
  setTimeout(() => {
  hideLoader();
  }, 5000); // Maximum 5 seconds loading time

  /* ==================== Console Message ==================== */
  console.log(
  '%cðŸš€ Welcome to the Portfolio! ',
  'color: #667eea; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);'
  );

  /* ==================== Parallax Effect for Background ==================== */
  window.addEventListener('scroll', () => {
  const scrolled = window.scrollY;
  const parallaxElements = document.querySelectorAll('.home-img img');

  parallaxElements.forEach(element => {
  const speed = 0.5;
  element.style.transform = `translateY(${scrolled * speed}px)`;
  });
  });

  /* ==================== Theme Toggle (Dark/Light Mode) ==================== */
  const themeToggle = document.getElementById('theme-toggle');
  const themeIcon = document.getElementById('theme-icon');

  // Check for saved theme preference or default to 'dark'
  const currentTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', currentTheme);

  // Update icon based on current theme
  updateThemeIcon(currentTheme);

  themeToggle.addEventListener('click', () => {
  const theme = document.documentElement.getAttribute('data-theme');
  const newTheme = theme === 'dark' ? 'light' : 'dark';

  // Add transition class
  document.documentElement.classList.add('theme-transitioning');

  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeIcon(newTheme);

  // Remove transition class after transition completes
  setTimeout(() => {
  document.documentElement.classList.remove('theme-transitioning');
  }, 300);
  });

  function updateThemeIcon(theme) {
  if (theme === 'dark') {
  themeIcon.classList.remove('bx-sun');
  themeIcon.classList.add('bx-moon');
  } else {
  themeIcon.classList.remove('bx-moon');
  themeIcon.classList.add('bx-sun');
  }
  }